<div class="d-flex flex-column justify-content-center mx-auto main-font mt-5" style="max-width: 1000px;">
    <h3>Choose Your Subscription Plan:</h3>
    <p>Your current plan: <%= current_user.subscription_plan.present? ? current_user.subscription.name : 'None' %></p>
    <p>Your remaining credit: $<%= current_user.subscription_plan.present? ? current_user.subscription.credit : '0.00' %></p>
</div>

<main class="card mx-auto p-4 bg-color border-0 mt-5" style="max-width: 1000px;">
  <div class="row d-flex align-items-center row-cols-1 row-cols-md-3 mb-2 text-center">
    <div class="col">
      <div class="card mb-4 rounded-5 shadow-sm border-1">
        <div class="card-header py-3 rounded-top-5">
          <h4 class="my-0 fw-normal">Free</h4>
        </div>
        <div class="card-body rounded-5 border-1">
          <h2 class="card-title pricing-card-title">&#x24; 0<small class="text-muted fw-light">/mo</small></h2>
          <ul class="list-unstyled mt-3 mb4">
            <li>Sample Perks</li>
            <li>Sample Perks</li>
          </ul>
          <button type="button" class="btn btn-lg btn-outline-secondary rounded-pill disabled" style="width: 80%;">Already signed up</button>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card mb-4 rounded-5 shadow border-1">
        <div class="card-header py-3 text-white bg-dark border-dark rounded-top-5">
          <h4 class="my-0 fw-normal">Monthly</h4>
        </div>
        <div class="card-body rounded-5 border-5 border-dark">
          <h2 class="card-title pricing-card-title">&#x24; 10<small class="text-muted fw-light">/monthly</small></h2>
          <ul class="list-unstyled mt-3 mb-4">
            <li>Sample Perks</li>
            <li>Sample Perks</li>
          </ul>
          <button class="btn btn-lg btn-dark rounded-pill" data-bs-target="#exampleModalToggle2" data-bs-toggle="modal" style="width: 80%;" data-plan-id="monthly_plan_id">Subscribe?</button>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card mb-4 rounded-5 shadow border-1">
        <div class="card-header py-3 text-white bg-primary border-primary rounded-top-5">
          <h4 class="my-0 fw-normal">Annual</h4>
        </div>
        <div class="card-body rounded-5 border-5 border-primary">
          <h2 class="card-title pricing-card-title">&#x24; 100<small class="text-muted fw-light">/annually</small></h2>
          <ul class="list-unstyled mt-3 mb-4">
            <li>Sample Perks</li>
            <li>Sample Perks</li>
          </ul>
          <button class="btn btn-lg btn-primary rounded-pill" data-bs-target="#exampleModalToggle2" data-bs-toggle="modal" style="width: 80%;" data-plan-id="annual_plan_id">Subscribe?</button>
        </div>
      </div>
    </div>
  </div>

  <h2 class="display-6 text-center mb-4">Compare plans</h2>

  <div class="table-responsive">
    <table class="table text-center">
      <thead>
        <tr>
          <th style="width: 34%; background-color: #f9f9fa;"></th>
          <th style="width: 34%; background-color: #f9f9fa;">Free</th>
          <th style="width: 34%; background-color: #f9f9fa;">Monthly</th>
          <th style="width: 34%; background-color: #f9f9fa;">Annual</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th scope="row" class="text-start" style="background-color: #f9f9fa;">Perks</th>
          <td style="background-color: #f9f9fa;">1</td>
          <td style="background-color: #f9f9fa;">Unlimited</td>
          <td style="background-color: #f9f9fa;">Unlimited</td>
        </tr>
        <tr>
          <th scope="row" class="text-start" style="background-color: #f9f9fa;">Perks</th>
          <td style="background-color: #f9f9fa;">10</td>
          <td style="background-color: #f9f9fa;">Unlimited</td>
          <td style="background-color: #f9f9fa;">Unlimited</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="d-flex flex-column justify-content-center mx-auto main-font mt-5 px-4" style="max-width: 1000px;">
    <h3>Need a custom plan?</h3>
    <p>We can help you decide what's the best for your company based on your needs. <a href="contact_us_path">Contact Us</a></p>
  </div>
</main>

<!-- Modal for subscription -->
<div class="modal fade" id="exampleModalToggle2" aria-hidden="true" aria-labelledby="exampleModalToggleLabel2" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalToggleLabel2">Subscribe to Premium</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Subscription form will be here -->
        <%= form_with url: subscriptions_path, method: :post, id: 'subscription-form' do %>
          <%= hidden_field_tag :stripeToken %>
          <%= hidden_field_tag :plan_id, '', id: 'selected-plan-id' %>
          <div class="form-group">
            <label for="card-element">Credit or debit card</label>
            <div id="card-element">
              <!-- A Stripe Element will be inserted here. -->
            </div>
            <div id="card-errors" role="alert"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Subscribe</button>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    var stripe = Stripe('<%= Rails.application.credentials.dig(:stripe, :publishable_key) %>');

    var form = document.getElementById('subscription-form');
    var planIdInput = document.getElementById('selected-plan-id');

    document.querySelectorAll('[data-bs-toggle="modal"]').forEach(button => {
      button.addEventListener('click', function(event) {
        var planId = event.target.getAttribute('data-plan-id');
        planIdInput.value = planId;
      });
    });

    form.addEventListener('submit', function(event) {
      event.preventDefault();

      stripe.createToken('card').then(function(result) {
        if (result.error) {
          console.error(result.error.message);
        } else {
          var hiddenInput = document.createElement('input');
          hiddenInput.setAttribute('type', 'hidden');
          hiddenInput.setAttribute('name', 'stripeToken');
          hiddenInput.setAttribute('value', result.token.id);
          form.appendChild(hiddenInput);

          form.submit();
        }
      });
    });
  });
</script>